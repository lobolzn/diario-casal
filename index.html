<script type="module">
  // Firebase SDKs (carregados direto do CDN)
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.0/firebase-app.js";
  import { getFirestore, collection, addDoc, onSnapshot, deleteDoc, doc } from "https://www.gstatic.com/firebasejs/10.13.0/firebase-firestore.js";
  import { getStorage, ref, uploadString, getDownloadURL, deleteObject } from "https://www.gstatic.com/firebasejs/10.13.0/firebase-storage.js";

  // ✅ Configuração do Firebase
  const firebaseConfig = {
    apiKey: "AIzaSyCLxiMUiF-PhsWL_E8JyztRhEUuMWoafTw",
    authDomain: "diario-casal.firebaseapp.com",
    projectId: "diario-casal",
    storageBucket: "diario-casal.firebasestorage.app",
    messagingSenderId: "701183585004",
    appId: "1:701183585004:web:7f6262d02a50ed434293c9"
  };

  // ✅ Inicializa Firebase
  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);
  const storage = getStorage(app);

  // =====================================================
  // ✅ AGORA VAI SALVAR ONLINE no Firestore e Storage
  // =====================================================

  // --- DOM Elements (iguais ao seu código)
  const galleryEl = document.getElementById('gallery')
  const timelineEl = document.getElementById('timeline')
  const emptyEl = document.getElementById('empty')
  const form = document.getElementById('momentForm')
  const titleIn = document.getElementById('title')
  const dateIn = document.getElementById('date')
  const descIn = document.getElementById('desc')
  const photoInput = document.getElementById('photoInput')
  const thumb = document.getElementById('thumb')
  const modal = document.getElementById('modal')
  const modalFigure = document.getElementById('modalFigure')
  const modalTitle = document.getElementById('modalTitle')
  const modalDate = document.getElementById('modalDate')
  const modalDesc = document.getElementById('modalDesc')
  const deleteBtn = document.getElementById('deleteBtn')

  let items = []
  let currentImageData = null
  let currentViewId = null

  // ✅ Carregar momentos do Firestore em tempo real
  const refMoments = collection(db, "momentos")
  onSnapshot(refMoments, async (snap) => {
    items = []
    snap.forEach(doc => items.push({id: doc.id, ...doc.data()}))
    renderAll()
  })

  // ✅ Enviar foto + salvar no Firestore
  form.addEventListener('submit', async (e)=>{
    e.preventDefault()

    const title = titleIn.value.trim() || 'Momento sem título'
    const date = dateIn.value || new Date().toISOString().slice(0,10)
    const desc = descIn.value.trim()

    let imageUrl = ""
    if (currentImageData) {
      const imageRef = ref(storage, `fotos/${Date.now()}.jpg`)
      await uploadString(imageRef, currentImageData, 'data_url')
      imageUrl = await getDownloadURL(imageRef)
    }

    await addDoc(refMoments, { title, date, desc, image: imageUrl })
    clearForm()
  })

  function renderAll(){
    renderGallery()
    renderTimeline()
    emptyEl.style.display = items.length ? 'none' : 'block'
  }

  function renderGallery(){
    galleryEl.innerHTML = ''
    items.slice().reverse().forEach(it => {
      const c = document.createElement('div')
      c.className = 'card'
      c.dataset.id = it.id
      c.innerHTML = `<img src="${it.image}"><div class="meta"><h3>${it.title}</h3><p>${it.date||''}</p></div>`
      c.addEventListener('click', ()=> openModal(it.id))
      galleryEl.appendChild(c)
    })
  }

  function renderTimeline(){
    timelineEl.innerHTML = ''
    items.slice().sort((a,b)=> new Date(b.date)-new Date(a.date)).forEach(it=>{
      const d = document.createElement('div')
      d.style.padding='10px 0'
      d.innerHTML = `<div style="display:flex;gap:12px;align-items:center">
        <div style='width:64px;height:64px;border-radius:8px;overflow:hidden'>
          <img src="${it.image}" style='width:64px;height:64px;object-fit:cover'>
        </div>
        <div style='flex:1'>
          <strong>${it.title}</strong>
          <div class='tiny'>${it.date||''}</div>
          <div style='color:var(--muted);margin-top:6px'>${it.desc||''}</div>
        </div>
        <div style='padding-left:8px'><button class='ghost' onclick="openModal('${it.id}')">Ver</button></div>
      </div>`
      timelineEl.appendChild(d)
    })
  }

  // ✅ Mostrar imagem carregada no formulário
  photoInput.addEventListener('change', (e)=>{
    const f = e.target.files[0]
    const reader = new FileReader()
    reader.onload = ()=>{ currentImageData = reader.result; thumb.innerHTML = `<img src="${reader.result}">` }
    reader.readAsDataURL(f)
  })

  function clearForm(){ form.reset(); currentImageData = null; thumb.innerHTML = 'Arraste ou clique para carregar' }

  // ✅ Abrir modal
  window.openModal = function(id){
    const it = items.find(x=>x.id===id)
    currentViewId = id
    modalFigure.innerHTML = `<img src='${it.image}'>`
    modalTitle.textContent = it.title
    modalDate.textContent = it.date
    modalDesc.textContent = it.desc
    modal.classList.add('open')
  }

  document.getElementById('closeBtn').addEventListener('click', ()=> modal.classList.remove('open'))

  // ✅ Excluir momento (Firestore + Storage)
  deleteBtn.addEventListener('click', async ()=>{
    if(!confirm("Excluir esse momento definitivamente?")) return
    const it = items.find(x=>x.id===currentViewId)

    await deleteDoc(doc(db, "momentos", currentViewId))

    // excluir a imagem do storage se tiver
    if (it.image.includes("firebasestorage")) {
      const fileRef = ref(storage, it.image)
      deleteObject(fileRef).catch(()=>{})
    }

    modal.classList.remove('open')
  })
</script>
